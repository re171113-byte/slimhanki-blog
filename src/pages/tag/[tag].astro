---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  const allTags = [...new Set(posts.flatMap(post => post.data.tags))];
  
  return allTags.map(tag => ({
    params: { tag: tag },
    props: { tag }
  }));
}

const { tag } = Astro.props;
const allPosts = await getCollection('posts');
const posts = allPosts
  .filter(post => post.data.tags.includes(tag))
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
  .map(post => ({
    slug: post.slug,
    title: post.data.title,
    description: post.data.description,
    image: post.data.image + '?w=600',
    category: post.data.category.replace(' 레시피', ''),
    date: post.data.pubDate.replace(/-/g, '.')
  }));
---

<BaseLayout title={`#${tag} - 슬림한끼`} description={`${tag} 관련 다이어트 레시피와 건강식 정보`}>
  <div class="tag-page">
    <div class="tag-header">
      <h1>#{tag}</h1>
      <p>{posts.length}개의 글</p>
    </div>

    <div class="posts-grid">
      {posts.map((post) => (
        <article class="post-card">
          <a href={`/posts/${post.slug}`}>
            <div class="image">
              <img src={post.image} alt={post.title} loading="lazy" />
              <span class="badge">{post.category}</span>
            </div>
            <div class="content">
              <h3>{post.title}</h3>
              <p>{post.description}</p>
              <span class="date">{post.date}</span>
            </div>
          </a>
        </article>
      ))}
    </div>
  </div>
</BaseLayout>

<style>
  .tag-page { max-width: 1000px; margin: 0 auto; padding: 48px 24px; }
  .tag-header { text-align: center; margin-bottom: 48px; }
  .tag-header h1 { font-size: 2rem; font-weight: 700; color: var(--accent); margin-bottom: 8px; }
  .tag-header p { color: var(--text-tertiary); }
  .posts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 28px; }
  .post-card { background: var(--bg-card); border-radius: 14px; overflow: hidden; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; }
  .post-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.08); }
  .post-card a { display: block; }
  .post-card .image { position: relative; aspect-ratio: 16/10; overflow: hidden; }
  .post-card .image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
  .post-card:hover .image img { transform: scale(1.05); }
  .post-card .image .badge { position: absolute; top: 14px; left: 14px; background: var(--text-primary); color: #fff; padding: 6px 14px; font-size: 0.75rem; font-weight: 600; }
  .post-card .content { padding: 22px; }
  .post-card h3 { font-size: 1.05rem; font-weight: 600; line-height: 1.5; margin-bottom: 10px; color: var(--text-primary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .post-card p { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .post-card .date { font-size: 0.8rem; color: var(--text-tertiary); }
  @media (max-width: 768px) { .posts-grid { grid-template-columns: 1fr; } }
</style>
