---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// ì¹´í…Œê³ ë¦¬ ìŠ¬ëŸ¬ê·¸ ë§¤í•‘
const categorySlugMap: Record<string, string> = {
  'ì €ì¹¼ë¡œë¦¬ ë ˆì‹œí”¼': 'low-cal',
  'K-ë‹¤ì´ì–´íŠ¸': 'k-diet',
  'ë‹¨ë°±ì§ˆ ì‹ë‹¨': 'protein',
  'ê°„í¸ì‹': 'quick',
  'ë°€í”„ë ™': 'mealprep',
  'ë‹¤ì´ì–´íŠ¸ ë°©ë²•': 'healthy'
};

const categorySlug = categorySlugMap[post.data.category] || 'low-cal';

// ê°™ì€ ì¹´í…Œê³ ë¦¬ì˜ ê´€ë ¨ ê¸€ ê°€ì ¸ì˜¤ê¸°
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.category === post.data.category)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
  .slice(0, 3)
  .map(p => ({
    slug: p.slug,
    title: p.data.title,
    image: p.data.image + '?w=400',
    category: p.data.category.replace(' ë ˆì‹œí”¼', '')
  }));
const { Content, headings, remarkPluginFrontmatter } = await post.render();

// TOCìš© H2, H3 í—¤ë”© í•„í„°ë§
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);

// ì½ê¸° ì‹œê°„ ê³„ì‚° (í•œê¸€ ê¸°ì¤€ ë¶„ë‹¹ ì•½ 500ì)
const wordCount = post.body.length;
const readingTime = Math.ceil(wordCount / 500);

// ì‘ì„±ì ì •ë³´
const author = {
  name: 'ìŠ¬ë¦¼í•œë¼',
  bio: 'ë‹¤ì´ì–´íŠ¸ ì‹ë‹¨ íë ˆì´í„°',
  description: 'ë‹¤ì´ì–´íŠ¸ ì •ë³´, ë³´ê¸° ì‰½ê²Œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.'
};
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  type="article"
  pubDate={post.data.pubDate}
  category={post.data.category}
  tags={post.data.tags}
  slug={post.slug}
>
  <!-- ë¸Œë ˆë“œí¬ëŸ¼ JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "í™ˆ", "item": "https://slimhanki-blog.pages.dev" },
      { "@type": "ListItem", "position": 2, "name": post.data.category, "item": `https://slimhanki-blog.pages.dev/category/${categorySlug}` },
      { "@type": "ListItem", "position": 3, "name": post.data.title }
    ]
  })} />

  <div class="post-wrapper">
    <article class="post-detail">
      <!-- ë¸Œë ˆë“œí¬ëŸ¼ ë„¤ë¹„ê²Œì´ì…˜ -->
      <nav class="breadcrumb" aria-label="breadcrumb">
        <ol>
          <li><a href="/">í™ˆ</a></li>
          <li><a href={`/category/${categorySlug}`}>{post.data.category}</a></li>
          <li aria-current="page">{post.data.title}</li>
        </ol>
      </nav>

      <div class="post-header">
        <div class="post-meta">
          <span class="category">{post.data.category}</span>
          <span class="meta-divider">Â·</span>
          <span class="date">{post.data.pubDate}</span>
          <span class="meta-divider">Â·</span>
          <span class="reading-time">ì•½ {readingTime}ë¶„</span>
        </div>
        <h1>{post.data.title}</h1>
        <p class="description">{post.data.description}</p>
        <div class="author-mini">
          <div class="author-avatar">ğŸ‘¨â€ğŸ³</div>
          <span class="author-name">{author.name}</span>
        </div>
        <div class="tags">
          {post.data.tags.map((tag: string) => (
            <a href={`/tag/${encodeURIComponent(tag)}`} class="tag">#{tag}</a>
          ))}
        </div>
      </div>

      <div class="post-hero">
        <img src={post.data.image} alt={post.data.title} />
      </div>

      <!-- ëª©ì°¨ (ì¸ë¼ì¸) -->
      {tocHeadings.length > 0 && (
        <nav class="toc-inline" aria-label="ëª©ì°¨">
          <h4>ì´ ê¸€ì˜ ë‚´ìš©</h4>
          <ul>
            {tocHeadings.filter(h => h.depth === 2).map((heading) => (
              <li>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))}
          </ul>
        </nav>
      )}

      <div class="post-content">
        <Content />
      </div>

      <!-- ê±´ê°• ê³ ì§€ë¬¸ -->
      <div class="health-disclaimer">
        <p>
          <strong>âš ï¸ ê±´ê°• ì•ˆë‚´</strong><br />
          ë³¸ ì½˜í…ì¸ ëŠ” ì •ë³´ ì œê³µ ëª©ì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ì˜í•™ì  ì¡°ì–¸ì„ ëŒ€ì²´í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          ê°œì¸ì˜ ê±´ê°• ìƒíƒœì— ë”°ë¼ ì „ë¬¸ê°€ì™€ ìƒë‹´ í›„ ì‹ë‹¨ì„ ì¡°ì ˆí•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
        </p>
      </div>

      <!-- ì‘ì„±ì í”„ë¡œí•„ -->
      <div class="author-profile">
        <div class="author-avatar-large">ğŸ‘¨â€ğŸ³</div>
        <div class="author-info">
          <h4>{author.name}</h4>
          <p class="author-bio">{author.bio}</p>
          <p class="author-description">{author.description}</p>
        </div>
      </div>

      {relatedPosts.length > 0 && (
        <div class="related-posts">
          <h3>ê´€ë ¨ ê¸€</h3>
          <div class="related-grid">
            {relatedPosts.map((related) => (
              <a href={`/posts/${related.slug}`} class="related-item">
                <img src={related.image} alt={related.title} loading="lazy" />
                <div class="related-info">
                  <span class="related-category">{related.category}</span>
                  <h4>{related.title}</h4>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

      <div class="post-footer">
        <div class="share-section">
          <h4>ì´ ê¸€ì´ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”?</h4>
          <p>ê³µìœ í•´ì„œ ë” ë§ì€ ë¶„ë“¤ê»˜ ì•Œë ¤ì£¼ì„¸ìš”!</p>
        </div>
        <a href="/" class="back-link">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      </div>
    </article>
  </div>
</BaseLayout>

<style>
  /* ì „ì²´ ë˜í¼ */
  .post-wrapper {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* ì¸ë¼ì¸ ëª©ì°¨ */
  .toc-inline {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    border-radius: 0 12px 12px 0;
    padding: 24px;
    margin-bottom: 40px;
  }

  .toc-inline h4 {
    font-size: 0.9rem;
    color: var(--accent);
    font-weight: 600;
    margin-bottom: 16px;
  }

  .toc-inline ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px 24px;
  }

  .toc-inline li {
    position: relative;
    padding-left: 16px;
  }

  .toc-inline li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 10px;
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
  }

  .toc-inline a {
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.6;
    transition: color 0.2s;
  }

  .toc-inline a:hover {
    color: var(--text-primary);
  }

  @media (max-width: 600px) {
    .toc-inline ul {
      grid-template-columns: 1fr;
    }
  }

  .post-detail {
    padding: 48px 0;
  }

  /* ë¸Œë ˆë“œí¬ëŸ¼ */
  .breadcrumb {
    margin-bottom: 32px;
  }

  .breadcrumb ol {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.85rem;
  }

  .breadcrumb li {
    display: flex;
    align-items: center;
    color: var(--text-tertiary);
  }

  .breadcrumb li:not(:last-child)::after {
    content: 'â€º';
    margin-left: 8px;
    color: var(--text-tertiary);
  }

  .breadcrumb a {
    color: var(--text-secondary);
    transition: color 0.2s;
  }

  .breadcrumb a:hover {
    color: var(--accent);
  }

  .breadcrumb li:last-child {
    color: var(--text-primary);
    font-weight: 500;
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .post-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .post-meta {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .meta-divider {
    color: var(--text-tertiary);
  }

  .category {
    background: var(--accent);
    color: #fff;
    padding: 6px 14px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .date, .reading-time {
    color: var(--text-tertiary);
    font-size: 0.9rem;
  }

  .reading-time {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .post-header h1 {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1.4;
    margin-bottom: 16px;
    color: var(--text-primary);
  }

  .description {
    font-size: 1.1rem;
    color: var(--text-secondary);
    line-height: 1.7;
    margin-bottom: 20px;
  }

  /* í—¤ë”ì˜ ì‘ì„±ì ë¯¸ë‹ˆ í”„ë¡œí•„ */
  .author-mini {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
  }

  .author-avatar {
    font-size: 1.5rem;
  }

  .author-name {
    font-size: 0.95rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
  }

  .tag {
    background: var(--bg-secondary);
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.85rem;
    color: var(--text-secondary);
  }

  .post-hero {
    margin-bottom: 48px;
    border-radius: 16px;
    overflow: hidden;
  }

  .post-hero img {
    width: 100%;
    height: auto;
    display: block;
  }

  .post-content {
    font-size: 1.05rem;
    line-height: 1.9;
    color: var(--text-primary);
  }

  .post-content :global(h2) {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 48px;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
  }

  .post-content :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 36px;
    margin-bottom: 16px;
  }

  .post-content :global(p) {
    margin-bottom: 20px;
  }

  .post-content :global(img) {
    width: 100%;
    border-radius: 12px;
    margin: 32px 0;
  }

  .post-content :global(em) {
    display: block;
    text-align: center;
    color: var(--text-tertiary);
    font-size: 0.9rem;
    margin-top: -24px;
    margin-bottom: 32px;
  }

  .post-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 24px 0;
    font-size: 0.95rem;
  }

  .post-content :global(th),
  .post-content :global(td) {
    padding: 12px 16px;
    border: 1px solid var(--border);
    text-align: left;
  }

  .post-content :global(th) {
    background: var(--bg-secondary);
    font-weight: 600;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin: 20px 0;
    padding-left: 24px;
  }

  .post-content :global(li) {
    margin-bottom: 8px;
  }

  .post-content :global(strong) {
    font-weight: 600;
    color: var(--text-primary);
  }

  .post-content :global(hr) {
    border: none;
    border-top: 1px solid var(--border);
    margin: 40px 0;
  }

  .post-content :global(blockquote) {
    border-left: 4px solid var(--accent);
    padding-left: 20px;
    margin: 24px 0;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* ê±´ê°• ê³ ì§€ë¬¸ */
  .health-disclaimer {
    margin-top: 48px;
    padding: 20px 24px;
    background: #FFF9E6;
    border: 1px solid #F0E6CC;
    border-radius: 12px;
    border-left: 4px solid #D4A574;
  }

  .health-disclaimer p {
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.7;
    color: #8B7355;
  }

  .health-disclaimer strong {
    color: #7A6248;
    font-size: 0.95rem;
  }

  /* ì‘ì„±ì í”„ë¡œí•„ */
  .author-profile {
    display: flex;
    gap: 20px;
    margin-top: 48px;
    padding: 32px;
    background: var(--bg-secondary);
    border-radius: 16px;
    border: 1px solid var(--border);
  }

  .author-avatar-large {
    font-size: 3.5rem;
    flex-shrink: 0;
  }

  .author-info {
    flex: 1;
  }

  .author-info h4 {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
  }

  .author-bio {
    font-size: 0.9rem;
    color: var(--accent);
    font-weight: 500;
    margin-bottom: 12px;
  }

  .author-description {
    font-size: 0.95rem;
    color: var(--text-secondary);
    line-height: 1.7;
    margin: 0;
  }

  .post-footer {
    margin-top: 64px;
    padding-top: 32px;
    border-top: 1px solid var(--border);
  }

  .share-section {
    text-align: center;
    background: var(--bg-secondary);
    padding: 32px;
    border-radius: 12px;
    margin-bottom: 24px;
  }

  .share-section h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .share-section p {
    color: var(--text-secondary);
    font-size: 0.95rem;
  }

  .back-link {
    display: inline-block;
    color: var(--accent);
    font-weight: 500;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--accent-light);
  }

  .related-posts { margin-top: 64px; padding-top: 48px; border-top: 1px solid var(--border); }
  .related-posts h3 { font-size: 1.3rem; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
  .related-posts h3::before { content: ''; width: 4px; height: 20px; background: var(--accent); border-radius: 2px; }
  .related-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
  .related-item { background: var(--bg-card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; }
  .related-item:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
  .related-item img { width: 100%; aspect-ratio: 16/10; object-fit: cover; }
  .related-info { padding: 16px; }
  .related-category { font-size: 0.75rem; color: var(--accent); font-weight: 600; }
  .related-info h4 { font-size: 0.95rem; font-weight: 600; line-height: 1.4; margin-top: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  @media (max-width: 768px) {
    .post-header h1 {
      font-size: 1.6rem;
    }

    .description {
      font-size: 1rem;
    }

    .post-content {
      font-size: 1rem;
    }

    .post-content :global(h2) {
      font-size: 1.3rem;
    }

    .post-content :global(h3) {
      font-size: 1.1rem;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<style>
  /* ì¹´ì¹´ì˜¤ ì• ë“œí• ê´‘ê³  ìŠ¤íƒ€ì¼ */
  .kakao-ad-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 40px 0;
    padding: 20px 0;
    min-height: 280px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .kakao-ad-container::before {
    content: 'ê´‘ê³ ';
    position: absolute;
    top: 8px;
    left: 12px;
    font-size: 0.7rem;
    color: var(--text-tertiary);
    letter-spacing: 0.05em;
  }
</style>

<!-- ì¹´ì¹´ì˜¤ ì• ë“œí• SDK -->
<script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>

<!-- ê´‘ê³  ìë™ ì‚½ì… ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.querySelector('.post-content');
    if (!content) return;

    const h2Tags = content.querySelectorAll('h2');
    if (h2Tags.length >= 2) {
      const adContainer = document.createElement('div');
      adContainer.className = 'kakao-ad-container';
      adContainer.innerHTML = '<ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-bSD7rshHVbBTIRG5" data-ad-width="300" data-ad-height="250"></ins>';
      h2Tags[1].parentNode.insertBefore(adContainer, h2Tags[1]);
    }
  });
</script>
