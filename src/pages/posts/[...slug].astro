---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// Category to URL slug mapping
const categorySlugMap: Record<string, string> = {
  'Romance': 'romance',
  'Action': 'action',
  'Comedy': 'comedy',
  'Historical': 'historical',
  'Thriller': 'thriller',
  'Comfort Food': 'comfort-food',
  'Street Food': 'street-food'
};

const categorySlug = categorySlugMap[post.data.category] || 'romance';

// Get related posts from the same category
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.category === post.data.category)
  .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
  .slice(0, 3)
  .map(p => ({
    slug: p.slug,
    title: p.data.title,
    image: p.data.image + '?w=400',
    category: p.data.category
  }));
const { Content, headings, remarkPluginFrontmatter } = await post.render();

// Filter H2, H3 headings for TOC
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);

// Calculate reading time (approx. 200 words per minute for English)
const wordCount = post.body.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);

// Author information
const author = {
  name: 'K-Drama Kitchen',
  bio: 'K-Drama Recipe Curator',
  description: 'Bringing the flavors of Korean dramas to your kitchen.'
};
// FAQ parsing function (supports ### Q. or ### Q1. format)
function parseFAQs(body: string): Array<{question: string, answer: string}> {
  const faqs: Array<{question: string, answer: string}> = [];
  const faqSectionMatch = body.match(/## (?:FAQ|Frequently Asked Questions)[\s\S]*?(?=\n## |$)/);
  if (!faqSectionMatch) return faqs;
  const faqSection = faqSectionMatch[0];
  const qaPattern = /### Q\d*\. (.+?)\n\n([^#]+?)(?=\n### |$)/g;
  let match;
  while ((match = qaPattern.exec(faqSection)) !== null) {
    const question = match[1].trim();
    const answer = match[2].trim().replace(/\n+/g, ' ');
    if (question && answer) {
      faqs.push({ question, answer });
    }
  }
  return faqs;
}

// FAQ 데이터 추출 및 스키마 생성
const faqs = parseFAQs(post.body);
const faqSchema = faqs.length > 0 ? {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
} : null;

---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={post.data.image}
  type="article"
  pubDate={post.data.pubDate}
  category={post.data.category}
  tags={post.data.tags}
  slug={post.slug}
>
  <!-- Breadcrumb JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://kdrama-kitchen.pages.dev" },
      { "@type": "ListItem", "position": 2, "name": post.data.category, "item": `https://kdrama-kitchen.pages.dev/category/${categorySlug}` },
      { "@type": "ListItem", "position": 3, "name": post.data.title }
    ]
  })} />
  <!-- FAQ JSON-LD -->
  {faqSchema && (
    <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
  )}

  <div class="post-wrapper">
    <article class="post-detail">
      <!-- Breadcrumb navigation -->
      <nav class="breadcrumb" aria-label="breadcrumb">
        <ol>
          <li><a href="/">Home</a></li>
          <li><a href={`/category/${categorySlug}`}>{post.data.category}</a></li>
          <li aria-current="page">{post.data.title}</li>
        </ol>
      </nav>

      <!-- Mobile: Hero image with overlay -->
      <div class="post-hero-mobile">
        <img
          src={`${post.data.image}?w=800&q=80&fm=webp`}
          srcset={`${post.data.image}?w=400&q=80&fm=webp 400w, ${post.data.image}?w=800&q=80&fm=webp 800w`}
          sizes="100vw"
          alt={post.data.title}
          class="hero-image"
          loading="eager"
          fetchpriority="high"
          decoding="async"
        />
        <div class="hero-overlay">
          <div class="hero-meta">
            <span class="hero-category" data-category={categorySlug}>{post.data.category}</span>
            <span class="hero-date">{post.data.pubDate} · {readingTime} min read</span>
          </div>
          <h1 class="hero-title">{post.data.title}</h1>
        </div>
      </div>

      <!-- PC: Header (Editorial Left Style) -->
      <div class="post-header-pc">
        <div class="category-line">
          <a href={`/category/${categorySlug}`} class="category-text" data-category={categorySlug}>{post.data.category}</a>
          <span class="header-divider"></span>
          <span class="reading-time">{readingTime} min read</span>
        </div>
        <h1>{post.data.title}</h1>
        <p class="description">{post.data.description}</p>
        <p class="byline">By <strong>{author.name}</strong> · {new Date(post.data.pubDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
      </div>

      <!-- PC: Hero image -->
      <div class="post-hero-pc">
        <img
          src={`${post.data.image}?w=1200&q=80&fm=webp`}
          srcset={`${post.data.image}?w=800&q=80&fm=webp 800w, ${post.data.image}?w=1200&q=80&fm=webp 1200w`}
          sizes="(max-width: 800px) 100vw, 800px"
          alt={post.data.title}
          loading="eager"
          fetchpriority="high"
          decoding="async"
        />
      </div>

      <!-- Table of Contents -->
      {tocHeadings.length > 0 && (
        <nav class="toc-inline" aria-label="Table of contents">
          <h4>In This Recipe</h4>
          <ul>
            {tocHeadings.filter(h => h.depth === 2).map((heading) => (
              <li>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))}
          </ul>
        </nav>
      )}

      <div class="post-content">
        <Content />
      </div>

      {relatedPosts.length > 0 && (
        <div class="related-posts">
          <h3>Related Recipes</h3>
          <div class="related-grid">
            {relatedPosts.map((related) => (
              <a href={`/posts/${related.slug}`} class="related-item">
                <img src={`${related.image}&fm=webp`} alt={related.title} loading="lazy" decoding="async" />
                <div class="related-info">
                  <span class="related-category">{related.category}</span>
                  <h4>{related.title}</h4>
                </div>
              </a>
            ))}
          </div>
        </div>
      )}

      <div class="post-footer">
        <a href="/" class="back-link">← Back to all recipes</a>
        <p class="footer-disclaimer">Recipe inspired by K-Drama scenes for entertainment purposes.</p>
      </div>
    </article>
  </div>
</BaseLayout>

<style>
  /* Main wrapper */
  .post-wrapper {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* 인라인 목차 */
  .toc-inline {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    border-radius: 0 12px 12px 0;
    padding: 24px;
    margin-bottom: 40px;
  }

  .toc-inline h4 {
    font-size: 0.9rem;
    color: var(--accent);
    font-weight: 600;
    margin-bottom: 16px;
  }

  .toc-inline ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px 24px;
  }

  .toc-inline li {
    position: relative;
    padding-left: 16px;
  }

  .toc-inline li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 10px;
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
  }

  .toc-inline a {
    color: var(--text-secondary);
    font-size: 0.9rem;
    line-height: 1.6;
    transition: color 0.2s;
  }

  .toc-inline a:hover {
    color: var(--text-primary);
  }

  @media (max-width: 600px) {
    .toc-inline ul {
      grid-template-columns: 1fr;
    }
  }

  .post-detail {
    padding: 48px 0;
  }

  /* 브레드크럼 */
  .breadcrumb {
    margin-bottom: 32px;
  }

  .breadcrumb ol {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
    list-style: none;
    padding: 0;
    margin: 0;
    font-size: 0.85rem;
  }

  .breadcrumb li {
    display: flex;
    align-items: center;
    color: var(--text-tertiary);
  }

  .breadcrumb li:not(:last-child)::after {
    content: '›';
    margin-left: 8px;
    color: var(--text-tertiary);
  }

  .breadcrumb a {
    color: var(--text-secondary);
    transition: color 0.2s;
  }

  .breadcrumb a:hover {
    color: var(--accent);
  }

  .breadcrumb li:last-child {
    color: var(--text-primary);
    font-weight: 500;
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ==================== 모바일 히어로 (개선안 B) ==================== */
  .post-hero-mobile {
    display: none; /* 기본: 숨김, 모바일에서만 표시 */
  }

  @media (max-width: 768px) {
    .post-hero-mobile {
      display: block;
      position: relative;
      height: 320px;
      overflow: hidden;
      border-radius: 0;
      margin: 0 -24px 32px -24px; /* wrapper padding 상쇄 */
    }

    .post-hero-mobile .hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-hero-mobile .hero-overlay {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 60%, transparent 100%);
      padding: 60px 20px 24px;
    }

    .post-hero-mobile .hero-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .post-hero-mobile .hero-category {
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 5px 10px;
      border-radius: 4px;
    }

    /* Mobile category colors */
    .hero-category[data-category="romance"] { background: #C62828; }
    .hero-category[data-category="thriller"] { background: #4A148C; }
    .hero-category[data-category="comedy"] { background: #EF6C00; }
    .hero-category[data-category="historical"] { background: #5D4037; }
    .hero-category[data-category="action"] { background: #D84315; }
    .hero-category[data-category="comfort-food"] { background: #8D6E63; }
    .hero-category[data-category="street-food"] { background: #00897B; }

    .post-hero-mobile .hero-date {
      color: rgba(255,255,255,0.7);
      font-size: 12px;
    }

    .post-hero-mobile .hero-title {
      color: #fff;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.4;
      margin: 0;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* PC 요소 숨김 */
    .post-header-pc {
      display: none;
    }

    .post-hero-pc {
      display: none;
    }
  }

  /* PC: Editorial Left Style Header */
  .post-header-pc {
    text-align: left;
    margin-bottom: 40px;
    max-width: 680px;
  }

  .category-line {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 24px;
  }

  .category-text {
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .category-text:hover {
    opacity: 0.7;
  }

  /* Category-specific colors */
  .category-text[data-category="romance"] { color: #C62828; }
  .category-text[data-category="thriller"] { color: #4A148C; }
  .category-text[data-category="comedy"] { color: #EF6C00; }
  .category-text[data-category="historical"] { color: #5D4037; }
  .category-text[data-category="action"] { color: #D84315; }
  .category-text[data-category="comfort-food"] { color: #8D6E63; }
  .category-text[data-category="street-food"] { color: #00897B; }

  .header-divider {
    width: 40px;
    height: 1px;
    background: var(--border);
  }

  .reading-time {
    font-size: 0.8rem;
    color: var(--text-tertiary);
  }

  .post-header-pc h1 {
    font-family: 'Playfair Display', Georgia, serif;
    font-size: 2.4rem;
    font-weight: 600;
    line-height: 1.25;
    margin-bottom: 20px;
    color: var(--text-primary);
    letter-spacing: -0.02em;
  }

  .post-header-pc .description {
    font-size: 1.15rem;
    color: var(--text-secondary);
    line-height: 1.7;
    margin-bottom: 24px;
  }

  .byline {
    font-size: 0.85rem;
    color: var(--text-tertiary);
    padding-top: 20px;
    border-top: 1px solid var(--border);
    margin: 0;
  }

  .byline strong {
    color: var(--text-primary);
    font-weight: 600;
  }

  .post-hero-pc {
    margin-bottom: 48px;
    border-radius: 12px;
    overflow: hidden;
  }

  .post-hero-pc img {
    width: 100%;
    height: auto;
    display: block;
  }


  .post-content {
    font-size: 1.05rem;
    line-height: 1.9;
    color: var(--text-primary);
  }

  .post-content :global(h2) {
    font-size: 1.5rem;
    font-weight: 700;
    margin-top: 48px;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
  }

  .post-content :global(h3) {
    font-size: 1.25rem;
    font-weight: 600;
    margin-top: 36px;
    margin-bottom: 16px;
  }

  .post-content :global(p) {
    margin-bottom: 20px;
  }

  .post-content :global(img) {
    width: 100%;
    border-radius: 12px;
    margin: 32px 0;
  }

  .post-content :global(em) {
    font-style: italic;
    color: inherit;
  }

  /* Image captions: em tag directly after img in the same paragraph */
  .post-content :global(img + em) {
    display: block;
    text-align: center;
    color: var(--text-tertiary);
    font-size: 0.9rem;
    margin-top: -24px;
    margin-bottom: 32px;
  }

  .post-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 24px 0;
    font-size: 0.95rem;
  }

  .post-content :global(th),
  .post-content :global(td) {
    padding: 12px 16px;
    border: 1px solid var(--border);
    text-align: left;
  }

  .post-content :global(th) {
    background: var(--bg-secondary);
    font-weight: 600;
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin: 20px 0;
    padding-left: 24px;
  }

  .post-content :global(li) {
    margin-bottom: 8px;
  }

  .post-content :global(strong) {
    font-weight: 600;
    color: var(--text-primary);
  }

  .post-content :global(hr) {
    border: none;
    border-top: 1px solid var(--border);
    margin: 40px 0;
  }

  .post-content :global(blockquote) {
    border-left: 4px solid var(--accent);
    padding-left: 20px;
    margin: 24px 0;
    color: var(--text-secondary);
    font-style: italic;
  }

  /* Post Footer */
  .post-footer {
    margin-top: 64px;
    padding-top: 32px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .back-link {
    color: var(--text-secondary);
    font-size: 0.9rem;
    font-weight: 500;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--text-primary);
  }

  .footer-disclaimer {
    font-size: 0.8rem;
    color: var(--text-tertiary);
    margin: 0;
  }

  .related-posts { margin-top: 64px; padding-top: 48px; border-top: 1px solid var(--border); }
  .related-posts h3 { font-size: 1.3rem; font-weight: 700; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
  .related-posts h3::before { content: ''; width: 4px; height: 20px; background: var(--accent); border-radius: 2px; }
  .related-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
  .related-item { background: var(--bg-card); border-radius: 12px; overflow: hidden; border: 1px solid var(--border); transition: transform 0.2s, box-shadow 0.2s; }
  .related-item:hover { transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
  .related-item img { width: 100%; aspect-ratio: 16/10; object-fit: cover; }
  .related-info { padding: 16px; }
  .related-category { font-size: 0.75rem; color: var(--accent); font-weight: 600; }
  .related-info h4 { font-size: 0.95rem; font-weight: 600; line-height: 1.4; margin-top: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  @media (max-width: 768px) {
    .post-header h1 {
      font-size: 1.6rem;
    }

    .description {
      font-size: 1rem;
    }

    .post-content {
      font-size: 1rem;
    }

    .post-content :global(h2) {
      font-size: 1.3rem;
    }

    .post-content :global(h3) {
      font-size: 1.1rem;
    }

    .related-grid {
      grid-template-columns: 1fr;
    }

    .post-footer {
      flex-direction: column;
      gap: 12px;
      text-align: center;
    }
  }
</style>

<style>
  /* 카카오 애드핏 광고 스타일 */
  .kakao-ad-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 40px 0;
    padding: 20px 0;
    min-height: 280px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border);
  }

  .kakao-ad-container::before {
    content: 'Ad';
    position: absolute;
    top: 8px;
    left: 12px;
    font-size: 0.7rem;
    color: var(--text-tertiary);
    letter-spacing: 0.05em;
  }
</style>

<!-- Kakao AdFit SDK -->
<script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>

<!-- Ad auto-insertion script -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const content = document.querySelector('.post-content');
    if (!content) return;

    const h2Tags = content.querySelectorAll('h2');
    if (h2Tags.length >= 2) {
      const adContainer = document.createElement('div');
      adContainer.className = 'kakao-ad-container';
      adContainer.innerHTML = '<ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-bSD7rshHVbBTIRG5" data-ad-width="300" data-ad-height="250"></ins>';
      h2Tags[1].parentNode.insertBefore(adContainer, h2Tags[1]);
    }
  });
</script>
